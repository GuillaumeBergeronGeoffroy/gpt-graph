<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPT-GRAPH</title>
  <!-- register css/lds-ellipsis -->
  <link rel="stylesheet" href="css/lds-ellipsis.css">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>
  <div id="graph-container">
    <div id="search-container">
      <span id="search-mode" onclick="toggleSearchMode()" title="Toggle AND/OR search">⛓</span>
      <input type="text" id="graph-search" placeholder="Search nodes..." />
      <span id="search-clear" onclick="clearSearch()">&times;</span>
    </div>
    <div id="graph-counter">
      <span id="node-count">0</span> nodes · <span id="rel-count">0</span> rels
    </div>
    <div id="zoom-controls">
      <button onclick="zoomIn()">+</button>
      <button onclick="zoomOut()">−</button>
      <button onclick="zoomReset()">⟲</button>
      <button id="info-btn" onclick="toggleHelp()">?</button>
    </div>
    <div id="minimap">
      <canvas id="minimap-canvas"></canvas>
      <div id="minimap-viewport"></div>
    </div>
    <div id="suggestion-panel">
      <div class="suggestion-header">
        <span>AI Suggestion</span>
        <span class="suggestion-close" onclick="closeSuggestion()">&times;</span>
      </div>
      <div id="suggestion-content"></div>
      <div class="suggestion-actions">
        <button class="suggestion-btn accept" onclick="executeSuggestion()">Execute</button>
        <button class="suggestion-btn skip" onclick="skipSuggestion()">Skip</button>
      </div>
    </div>
    <div id="help-panel">
      <div class="help-title">Controls</div>
      <div class="help-item"><span>Scroll</span> Zoom in/out</div>
      <div class="help-item"><span>Drag background</span> Pan view</div>
      <div class="help-item"><span>Drag node</span> Move node</div>
      <div class="help-item"><span>Click node</span> Show options</div>
      <div class="help-item"><span>Drag select</span> Batch select nodes</div>
      <div class="help-title" style="margin-top:12px">Actions</div>
      <div class="help-item"><span>Generate</span> Build graph from prompt</div>
      <div class="help-item"><span>Merge</span> Extract text → graph</div>
      <div class="help-item"><span>Expand</span> Grow graph with AI</div>
      <div class="help-item"><span>Synthesize</span> Find dialectical tensions</div>
      <div class="help-item"><span>Audit</span> Grounding check (3 tests)</div>
      <div class="help-item"><span>Suggest</span> AI recommends next action</div>
      <div class="help-item"><span>Auto</span> Full autopilot research</div>
      <div class="help-item"><span>Chat</span> Ask questions using graph</div>
    </div>
    <div id="graph"></div>
  </div>
  <div id="log-panel">
    <div id="log-header">
      <span>Activity Log</span>
      <div id="log-controls">
        <span id="log-expand" onclick="toggleLogExpand()" title="Expand">⤢</span>
        <span id="log-toggle" onclick="toggleLogPanel()">−</span>
      </div>
    </div>
    <div id="log-content"></div>
  </div>
  <div id="prompt-container">
    <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
    <div id="prompt-dragable-top" class="dragable-top"><img src="img/drag.png"/></div>
    <div id="prompt-pending-attachments" class="pending-attachments"></div>
    <textarea id="text-container" placeholder="Enter a research topic to generate, or paste text to merge..."></textarea>
    <div id='params-container'>
        <div id="generate-button" class="buttons disabled" onclick="generateGraph()">
            <span class="btn-label">Generate</span>
            <span class="btn-hint">prompt → graph</span>
        </div>
        <div id="extract-button" class="buttons disabled" onclick="getObject()">
            <span class="btn-label">Merge</span>
            <span class="btn-hint">text → graph</span>
        </div>
    </div>
    <div id='params-container-2'>
        <div id="research-button" class="buttons" onclick="researchGraph()">
            <span class="btn-label">Expand</span>
            <span class="btn-hint">grow graph</span>
        </div>
        <div id="synthesis-button" class="buttons" onclick="runDialecticalSynthesis()">
            <span class="btn-label">Synthesize</span>
            <span class="btn-hint">find tensions</span>
        </div>
    </div>
    <div id='params-container-3'>
        <div id="ground-button" class="buttons" onclick="runGroundingCheck()">
            <span class="btn-label">Audit</span>
            <span class="btn-hint">grounding check</span>
        </div>
    </div>
    <div id='suggest-container'>
        <div id="suggest-button" class="buttons" onclick="suggestNextAction()">
            <span class="btn-label">Suggest</span>
            <span class="btn-hint">AI recommends</span>
        </div>
        <div id="auto-toggle" class="buttons" onclick="toggleAutoMode()">
            <span class="btn-label" id="auto-label">Auto</span>
            <span class="btn-hint">full autopilot</span>
        </div>
    </div>
    <div id='chat-container'>
        <div id="chat-button" class="buttons" onclick="talkWithGraph()">
            <span class="btn-label">Chat</span>
            <span class="btn-hint">talk with graph</span>
        </div>
    </div>
    <div id="task-monitor" class="hidden">
        <div class="task-monitor-header" onclick="talkWithGraph()">
            <span class="task-monitor-indicator"></span>
            <span class="task-monitor-label">Task Running</span>
            <span class="task-monitor-lines">0 lines</span>
        </div>
        <div class="task-monitor-preview"></div>
    </div>
    <div id='io-container'>
        <div id="import-button" class="buttons" onclick="document.getElementById('import-graph').click()">Import</div>
        <input type="file" id="import-graph" style="display: none;" onchange="importGraph()">
        <div id="download-button" class="buttons" onclick="downloadGraph()">Download</div>
    </div>
    <!-- <div id='server-status' class="setting-prompt">Using local Claude account (run server.py)</div> -->
    <div id="clear-button" class="buttons" onclick="confirmClearHistory()">Clear</div>
    <div id="brain-button" onclick="openBrainDashboard()">
      Brain <span id="brain-indicator" class="brain-indicator"></span>
    </div>
    <div id="graph-selector" onclick="openGraphSelector()">
      <span id="current-graph-name">No Graph</span>
      <span class="selector-arrow">▾</span>
    </div>
  </div>

  <!-- Brain Dashboard Modal -->
  <div id="brain-modal" class="hidden">
    <div class="brain-content">
      <div class="brain-header">
        <span>Brain Dashboard</span>
        <div class="brain-header-right">
          <a href="brain.html" target="_blank" style="font-size:11px;color:rgba(255,255,255,0.5);text-decoration:none;">Open Full View</a>
          <span id="brain-connection" class="brain-dot connected"></span>
          <span class="brain-close" onclick="closeBrainDashboard()">&times;</span>
        </div>
      </div>
      <div class="brain-body">
        <div class="brain-controls">
          <div class="brain-status-row">
            <span id="brain-status-text" class="brain-status stopped">Stopped</span>
            <span class="brain-iter-label">Iteration: <strong id="brain-iteration">0</strong></span>
          </div>
          <div class="brain-workspace-row">
            <label>Workspace:</label>
            <select id="brain-workspace" onchange="switchBrainWorkspace(this.value)">
              <option value="default">default</option>
            </select>
            <button class="brain-ws-btn" onclick="createBrainWorkspace()" title="New workspace">+</button>
            <button class="brain-ws-btn brain-ws-del" onclick="deleteBrainWorkspace()" title="Delete workspace">&times;</button>
          </div>
          <textarea id="brain-prompt" placeholder="Enter agent goals... What should the autonomous agent work on?" rows="4"></textarea>
          <div class="brain-config-row">
            <label>Delay between iterations (seconds):
              <input type="number" id="brain-interval" value="0" min="0" step="1">
            </label>
          </div>
          <div class="brain-btn-row">
            <button id="brain-start-btn" onclick="startBrainLoop()">Start Loop</button>
            <button id="brain-stop-btn" onclick="stopBrainLoop()" disabled>Stop Loop</button>
            <button onclick="configureBrainLoop()">Save Config</button>
          </div>
        </div>
        <div class="brain-section">
          <div class="brain-section-title">Graphs</div>
          <div id="brain-graphs" class="brain-graphs-list"></div>
        </div>
        <div class="brain-section">
          <div class="brain-section-title">Activity Feed</div>
          <div id="brain-feed" class="brain-feed"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Graph Selector Modal -->
  <div id="graph-selector-modal" class="hidden">
    <div class="selector-content">
      <div class="selector-header">
        <span>Your Graphs</span>
        <span class="selector-close" onclick="closeGraphSelector()">&times;</span>
      </div>
      <div class="selector-actions">
        <button class="new-graph-btn" onclick="createNewGraph()">+ New Graph</button>
        <button class="merge-mode-btn" onclick="toggleMergeMode()">
          <span class="merge-icon">⚡</span> Merge Graphs
        </button>
      </div>
      <div id="merge-controls" class="hidden">
        <div class="merge-info">Select 2+ graphs to merge with AI analysis</div>
        <div class="merge-actions">
          <button class="merge-cancel-btn" onclick="toggleMergeMode()">Cancel</button>
          <button class="merge-execute-btn" onclick="executeMergeGraphs()" disabled>
            Merge Selected (<span id="merge-count">0</span>)
          </button>
        </div>
      </div>
      <div id="graph-list"></div>
    </div>
  </div>
  
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="storage.js"></script>
  <script src="prompt.js"></script>
  <script src="renderGraph.js"></script>
  <script src="dragElement.js"></script>
  <script src="history.js"></script>
  <script src="download.js"></script>
  <script src="import.js"></script>
  <script src="brain.js"></script>
</body>
</html>

<script>
  window.addEventListener('load', async () => {
    // Ensure loading state is cleared
    document.getElementById('prompt-container').classList.remove('loading');
    dragElement(document.getElementById('prompt-dragable-top'));
    registerPromptListeners();

    // Initialize IndexedDB storage
    try {
      const result = await initializeStorage();
      if (result) {
        if (result.data) {
          // Loaded a graph
          merged_object_history = result.data.history || [];
          merged_object_history_index = result.data.historyIndex || 0;
          merged_object = result.data.merged_object;

          // Restore grounding data from serialized properties
          if (merged_object?.nodes) {
            merged_object.nodes.forEach(node => {
              if (node.properties?.grounding && !node.grounding) {
                const groundingStr = node.properties.grounding;
                // Only try to parse if it looks like JSON (starts with {)
                if (typeof groundingStr === 'string' && groundingStr.trim().startsWith('{')) {
                  try {
                    node.grounding = JSON.parse(groundingStr);
                  } catch (e) {
                    // Invalid JSON, clear the field
                    delete node.properties.grounding;
                  }
                } else {
                  // Not JSON, clear the invalid field
                  delete node.properties.grounding;
                }
              }
            });
          }

          updateCurrentGraphName(result.name);
          if (merged_object) {
            renderGraph(merged_object);
          }
          // Load chat for this graph
          chatHistory = await loadChatForGraph(result.id);
        } else {
          // Just have an ID (from migration)
          updateCurrentGraphName('Migrated Graph');
        }
      }
    } catch (e) {
      console.warn('Storage initialization failed, falling back:', e);
      // Fallback to old localStorage method
      initializeHistoryFromLocalStorage();
      loadChatHistory();
    }

    loadActivityLogFromStorage();
  });

  function updateCurrentGraphName(name) {
    const el = document.getElementById('current-graph-name');
    if (el) {
      el.textContent = name || 'No Graph';
    }
  }

  async function openGraphSelector() {
    const modal = document.getElementById('graph-selector-modal');
    modal.classList.remove('hidden');
    await refreshGraphList();
  }

  function closeGraphSelector() {
    document.getElementById('graph-selector-modal').classList.add('hidden');
  }

  async function refreshGraphList() {
    const list = document.getElementById('graph-list');
    const graphs = await listGraphs();

    if (graphs.length === 0) {
      list.innerHTML = '<div class="no-graphs">No graphs yet. Create one to get started.</div>';
      return;
    }

    list.innerHTML = graphs.map(g => {
      const isActive = g.id === currentGraphId;
      const isSelected = selectedGraphsForMerge.has(g.id);
      const date = new Date(g.updatedAt).toLocaleDateString();

      if (mergeMode) {
        return `
          <div class="graph-item ${isActive ? 'active' : ''} ${isSelected ? 'selected-for-merge' : ''}"
               data-graph-id="${g.id}"
               onclick="toggleGraphSelection('${g.id}', event)">
            <div class="merge-checkbox ${isSelected ? 'checked' : ''}">
              ${isSelected ? '✓' : ''}
            </div>
            <div class="graph-item-info">
              <div class="graph-item-name">${escapeHtml(g.name)}</div>
              <div class="graph-item-meta">${g.nodeCount} nodes · ${g.relCount} rels · ${date}</div>
            </div>
          </div>
        `;
      }

      return `
        <div class="graph-item ${isActive ? 'active' : ''}" onclick="switchToGraph('${g.id}')">
          <div class="graph-item-info">
            <div class="graph-item-name">${escapeHtml(g.name)}</div>
            <div class="graph-item-meta">${g.nodeCount} nodes · ${g.relCount} rels · ${date}</div>
          </div>
          <div class="graph-item-actions">
            <button class="graph-action-btn" onclick="event.stopPropagation(); renameGraphPrompt('${g.id}', '${escapeHtml(g.name)}')">Rename</button>
            <button class="graph-action-btn delete" onclick="event.stopPropagation(); confirmDeleteGraph('${g.id}', '${escapeHtml(g.name)}')">Delete</button>
          </div>
        </div>
      `;
    }).join('');
  }

  async function switchToGraph(graphId) {
    // Save current graph first
    if (currentGraphId && merged_object?.nodes?.length > 0) {
      await saveGraph({});
      await saveChatForGraph(currentGraphId, chatHistory);
    }

    // Load new graph
    const graph = await loadGraph(graphId);
    if (graph) {
      merged_object_history = graph.data.history || [];
      merged_object_history_index = graph.data.historyIndex || 0;
      merged_object = graph.data.merged_object;

      // Restore grounding data from serialized properties
      if (merged_object?.nodes) {
        merged_object.nodes.forEach(node => {
          if (node.properties?.grounding && !node.grounding) {
            const groundingStr = node.properties.grounding;
            // Only try to parse if it looks like JSON (starts with {)
            if (typeof groundingStr === 'string' && groundingStr.trim().startsWith('{')) {
              try {
                node.grounding = JSON.parse(groundingStr);
              } catch (e) {
                delete node.properties.grounding;
              }
            } else {
              delete node.properties.grounding;
            }
          }
        });
      }

      // Load chat for this graph
      chatHistory = await loadChatForGraph(graphId);

      updateCurrentGraphName(graph.name);

      if (merged_object) {
        renderGraph(merged_object);
      } else {
        d3.select("#graph").selectAll("svg").remove();
      }

      if (typeof updateGraphCounter === 'function') {
        updateGraphCounter();
      }

      closeGraphSelector();
    }
  }

  async function createNewGraph() {
    // Save current graph first
    if (currentGraphId && merged_object?.nodes?.length > 0) {
      await saveGraph({});
      await saveChatForGraph(currentGraphId, chatHistory);
    }

    // Reset state
    merged_object = null;
    merged_object_history = [];
    merged_object_history_index = 0;
    chatHistory = [];
    currentGraphId = null;

    // Get name for new graph
    const name = prompt('Enter a name for the new graph:', 'New Graph');
    if (name === null) return; // Cancelled

    // Create and save
    currentGraphId = generateGraphId();
    await saveGraph({ merged_object: { nodes: [], relationships: [] } }, name || 'New Graph');

    updateCurrentGraphName(name || 'New Graph');
    d3.select("#graph").selectAll("svg").remove();

    if (typeof updateGraphCounter === 'function') {
      updateGraphCounter();
    }

    closeGraphSelector();
  }

  async function renameGraphPrompt(graphId, currentName) {
    const newName = prompt('Enter new name:', currentName);
    if (newName && newName !== currentName) {
      await renameGraph(graphId, newName);
      if (graphId === currentGraphId) {
        updateCurrentGraphName(newName);
      }
      await refreshGraphList();
    }
  }

  async function confirmDeleteGraph(graphId, name) {
    if (confirm(`Delete "${name}"? This cannot be undone.`)) {
      await deleteGraph(graphId);

      if (graphId === currentGraphId) {
        // Switch to another graph or create empty state
        const graphs = await listGraphs();
        if (graphs.length > 0) {
          await switchToGraph(graphs[0].id);
        } else {
          merged_object = null;
          merged_object_history = [];
          merged_object_history_index = 0;
          chatHistory = [];
          currentGraphId = null;
          updateCurrentGraphName('No Graph');
          d3.select("#graph").selectAll("svg").remove();
        }
      }

      await refreshGraphList();
    }
  }

  // ============ GRAPH MERGE FUNCTIONS ============

  let mergeMode = false;
  let selectedGraphsForMerge = new Set();

  function toggleMergeMode() {
    mergeMode = !mergeMode;
    selectedGraphsForMerge.clear();

    const controls = document.getElementById('merge-controls');
    const btn = document.querySelector('.merge-mode-btn');

    if (mergeMode) {
      controls.classList.remove('hidden');
      btn.classList.add('active');
    } else {
      controls.classList.add('hidden');
      btn.classList.remove('active');
    }

    refreshGraphList();
    updateMergeCount();
  }

  function toggleGraphSelection(graphId, event) {
    event.stopPropagation();

    if (selectedGraphsForMerge.has(graphId)) {
      selectedGraphsForMerge.delete(graphId);
    } else {
      selectedGraphsForMerge.add(graphId);
    }

    // Update checkbox visual
    const checkbox = document.querySelector(`[data-graph-id="${graphId}"] .merge-checkbox`);
    if (checkbox) {
      checkbox.classList.toggle('checked', selectedGraphsForMerge.has(graphId));
    }

    // Update item selection visual
    const item = document.querySelector(`[data-graph-id="${graphId}"]`);
    if (item) {
      item.classList.toggle('selected-for-merge', selectedGraphsForMerge.has(graphId));
    }

    updateMergeCount();
  }

  function updateMergeCount() {
    const countEl = document.getElementById('merge-count');
    const btn = document.querySelector('.merge-execute-btn');
    const count = selectedGraphsForMerge.size;

    if (countEl) countEl.textContent = count;
    if (btn) btn.disabled = count < 2;
  }

  async function executeMergeGraphs() {
    if (selectedGraphsForMerge.size < 2) {
      alert('Select at least 2 graphs to merge');
      return;
    }

    const graphIds = Array.from(selectedGraphsForMerge);

    // Load all selected graphs
    const graphs = [];
    for (const id of graphIds) {
      const graph = await loadGraph(id);
      if (graph) {
        graphs.push(graph);
      }
    }

    if (graphs.length < 2) {
      alert('Could not load selected graphs');
      return;
    }

    // Close modal and show progress
    closeGraphSelector();
    toggleMergeMode();

    // Call the merge function in prompt.js
    await mergeGraphsWithClaude(graphs);
  }

  function toggleHelp() {
    document.getElementById('help-panel').classList.toggle('visible');
  }

  // escapeHtml for graph selector (also defined in prompt.js but needed here for early use)
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>